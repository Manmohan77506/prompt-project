<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders - PharmaSoft</title>
  <link rel="stylesheet" href="style.css">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #f0f2f5;
    }

    .orders-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .page-hero {
      background: white;
      border-radius: 30px;
      padding: 50px;
      margin-bottom: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.06);
      position: relative;
      overflow: hidden;
    }

    .page-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .hero-content {
      position: relative;
      z-index: 1;
    }

    .hero-title {
      font-size: 48px;
      font-weight: 800;
      color: #1e293b;
      margin: 0 0 15px 0;
      letter-spacing: -1px;
    }

    .hero-subtitle {
      font-size: 18px;
      color: #64748b;
      margin: 0 0 30px 0;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .metric-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 25px;
      border-radius: 20px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
    }

    .metric-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin: 5px 0;
    }

    .metric-label {
      font-size: 14px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .controls-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-container {
      flex: 1;
      min-width: 300px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 18px 50px 18px 55px;
      border: 2px solid #e2e8f0;
      border-radius: 50px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: white;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .search-icon-wrapper {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: #94a3b8;
    }

    .clear-search {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: #e2e8f0;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .clear-search:hover {
      background: #cbd5e1;
    }

    .filter-group {
      display: flex;
      gap: 10px;
      background: white;
      padding: 8px;
      border-radius: 50px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .filter-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: transparent;
      color: #64748b;
    }

    .filter-btn:hover {
      background: #f1f5f9;
      color: #1e293b;
    }

    .filter-btn.active {
      background: #3b82f6;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .orders-grid {
      display: grid;
      gap: 25px;
    }

    .order-card {
      background: white;
      border-radius: 25px;
      padding: 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
      overflow: hidden;
      border: 2px solid transparent;
    }

    .order-card:hover {
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
      border-color: #3b82f6;
      transform: translateY(-4px);
    }

    .order-card-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      padding: 30px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .order-number {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .order-date-display {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 5px;
    }

    .status-badge {
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge.confirmed {
      background: #10b981;
      color: white;
    }

    .status-badge.pending {
      background: #f59e0b;
      color: white;
    }

    .status-badge.delivered {
      background: #06b6d4;
      color: white;
    }

    .status-badge.cancelled {
      background: #ef4444;
      color: white;
    }

    .order-card-body {
      padding: 30px;
    }

    .order-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
    }

    .items-section {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 15px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .item-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 15px;
      transition: all 0.2s ease;
    }

    .item-row:hover {
      background: #f1f5f9;
      transform: translateX(5px);
    }

    .item-icon {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .item-details {
      flex: 1;
    }

    .item-name-display {
      font-weight: 600;
      color: #1e293b;
      margin: 0 0 5px 0;
      font-size: 15px;
    }

    .item-meta {
      font-size: 13px;
      color: #64748b;
    }

    .item-price-display {
      font-size: 18px;
      font-weight: 700;
      color: #3b82f6;
    }

    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .summary-box {
      background: #f8fafc;
      padding: 25px;
      border-radius: 20px;
      border: 2px solid #e2e8f0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 15px;
    }

    .summary-row:not(:last-child) {
      border-bottom: 1px solid #e2e8f0;
    }

    .summary-row.total {
      font-size: 20px;
      font-weight: 700;
      color: #3b82f6;
      padding-top: 15px;
      margin-top: 10px;
      border-top: 2px solid #cbd5e1;
    }

    .address-box {
      background: #fef3c7;
      padding: 25px;
      border-radius: 20px;
      border: 2px solid #fbbf24;
    }

    .address-title {
      font-size: 14px;
      font-weight: 700;
      color: #92400e;
      margin: 0 0 15px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .address-content {
      font-size: 14px;
      color: #451a03;
      line-height: 1.8;
    }

    .address-content strong {
      display: block;
      font-size: 16px;
      margin-bottom: 8px;
      color: #78350f;
    }

    .action-bar {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .action-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-btn-primary {
      background: #3b82f6;
      color: white;
    }

    .action-btn-primary:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
    }

    .action-btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 2px solid #e2e8f0;
    }

    .action-btn-secondary:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    .empty-state {
      text-align: center;
      padding: 100px 20px;
      background: white;
      border-radius: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.06);
    }

    .empty-icon {
      font-size: 120px;
      margin-bottom: 30px;
      opacity: 0.3;
    }

    .empty-title {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 15px 0;
    }

    .empty-description {
      font-size: 18px;
      color: #64748b;
      margin: 0 0 40px 0;
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 100px 20px;
      gap: 30px;
    }

    .loading-animation {
      width: 80px;
      height: 80px;
      position: relative;
    }

    .loading-circle {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 6px solid #e2e8f0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: rotate 1s linear infinite;
    }

    @keyframes rotate {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      color: #64748b;
      font-weight: 600;
    }

    @media (max-width: 1024px) {
      .order-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .page-hero {
        padding: 30px 20px;
      }

      .hero-title {
        font-size: 32px;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .filter-group {
        width: 100%;
        overflow-x: auto;
      }

      .search-container {
        width: 100%;
        min-width: auto;
      }

      .order-card-header {
        padding: 20px;
      }

      .order-number {
        font-size: 20px;
      }

      .action-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="logo">PharmaSoft</div>
    <nav class="nav">
      <a href="delivery.html">Delivery Address</a>
      <a href="ayurvedic.html">Ayurvedic Medicine</a>
      <a href="generic.html">Generic Medicine</a>
      <a href="login.html">Login</a>
      <a href="cart.html">üõí Cart (<span id="cart-count">0</span>)</a>
      <a href="index.html">Home</a>
      <button id="logout-btn" style="display: none;">Logout</button>
    </nav>
  </header>

  <!-- Page Content -->
  <section class="page-content">
    <div class="orders-container">
      
      <div class="page-hero">
        <div class="hero-content">
          <h1 class="hero-title">Your Orders</h1>
          <p class="hero-subtitle">Track and manage all your pharmaceutical orders in one place</p>
          
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-icon">üì¶</div>
              <div class="metric-value" id="total-orders">0</div>
              <div class="metric-label">Total Orders</div>
            </div>
            <div class="metric-card">
              <div class="metric-icon">üí∞</div>
              <div class="metric-value" id="total-spent">‚Çπ0</div>
              <div class="metric-label">Total Spent</div>
            </div>
            <div class="metric-card">
              <div class="metric-icon">‚úÖ</div>
              <div class="metric-value" id="delivered-count">0</div>
              <div class="metric-label">Delivered</div>
            </div>
            <div class="metric-card">
              <div class="metric-icon">‚è≥</div>
              <div class="metric-value" id="pending-count">0</div>
              <div class="metric-label">In Progress</div>
            </div>
          </div>
        </div>
      </div>

      <div class="controls-bar">
        <div class="search-container">
          <span class="search-icon-wrapper">üîç</span>
          <input 
            type="text" 
            id="search-input" 
            class="search-input" 
            placeholder="Search by order ID, medicine name, or address..."
          >
          <button class="clear-search" id="clear-search">‚úï</button>
        </div>
        
        <div class="filter-group">
          <button class="filter-btn active" data-status="all">All</button>
          <button class="filter-btn" data-status="pending">Pending</button>
          <button class="filter-btn" data-status="confirmed">Confirmed</button>
          <button class="filter-btn" data-status="delivered">Delivered</button>
          <button class="filter-btn" data-status="cancelled">Cancelled</button>
        </div>
      </div>

      <div id="loading-state" class="loading-state">
        <div class="loading-animation">
          <div class="loading-circle"></div>
        </div>
        <div class="loading-text">Loading your orders...</div>
      </div>

      <div id="orders-container" class="orders-grid" style="display: none;">
        <!-- Orders will be loaded here -->
      </div>
    </div>
  </section>

  <script src="script.js"></script>
  <script>
    let allOrders = [];
    let filteredOrders = [];
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', () => {
      if (!auth.isLoggedIn()) {
        showUnauthorizedMessage();
        return;
      }

      loadOrders();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.status;
          applyFilters();
        });
      });

      // Search input
      const searchInput = document.getElementById('search-input');
      const clearBtn = document.getElementById('clear-search');
      
      searchInput.addEventListener('input', (e) => {
        clearBtn.style.display = e.target.value ? 'flex' : 'none';
        applyFilters();
      });

      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        applyFilters();
      });
    }

    function showUnauthorizedMessage() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('orders-container').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üîí</div>
          <h2 class="empty-title">Authentication Required</h2>
          <p class="empty-description">Please log in to view your order history</p>
          <button onclick="window.location.href='login.html'" class="action-btn action-btn-primary" style="max-width: 200px; margin: 0 auto;">
            Log In
          </button>
        </div>
      `;
      document.getElementById('orders-container').style.display = 'block';
    }

    async function loadOrders() {
      try {
        document.getElementById('loading-state').style.display = 'flex';
        document.getElementById('orders-container').style.display = 'none';

        // Use window.apiCall to access the function from script.js
        if (typeof window.apiCall !== 'function') {
          throw new Error('API connection not available. Please refresh the page.');
        }

        const data = await window.apiCall('/orders');
        allOrders = data.orders || [];
        filteredOrders = [...allOrders];
        
        updateMetrics();
        applyFilters();
        
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('orders-container').style.display = 'grid';
        
      } catch (error) {
        console.error('Failed to load orders:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('orders-container').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <h2 class="empty-title">Failed to Load Orders</h2>
            <p class="empty-description">We couldn't retrieve your orders. Please try again.</p>
            <button onclick="loadOrders()" class="action-btn action-btn-primary" style="max-width: 200px; margin: 0 auto;">
              Retry
            </button>
          </div>
        `;
        document.getElementById('orders-container').style.display = 'block';
        showToast('Failed to load orders', 'error');
      }
    }

    function updateMetrics() {
      const totalOrders = allOrders.length;
      
      // Only count non-cancelled orders in total spent
      const totalSpent = allOrders
        .filter(o => o.status !== 'cancelled')
        .reduce((sum, order) => sum + order.total, 0);
      
      const deliveredCount = allOrders.filter(o => o.status === 'delivered').length;
      const pendingCount = allOrders.filter(o => o.status === 'pending' || o.status === 'confirmed').length;
      
      document.getElementById('total-orders').textContent = totalOrders;
      document.getElementById('total-spent').textContent = `‚Çπ${totalSpent.toFixed(0)}`;
      document.getElementById('delivered-count').textContent = deliveredCount;
      document.getElementById('pending-count').textContent = pendingCount;
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      
      filteredOrders = allOrders.filter(order => {
        const matchesStatus = currentFilter === 'all' || order.status === currentFilter;
        const matchesSearch = !searchTerm || 
          order.orderId.toLowerCase().includes(searchTerm) ||
          order.items.some(item => item.name.toLowerCase().includes(searchTerm)) ||
          order.deliveryAddress.address.toLowerCase().includes(searchTerm) ||
          order.deliveryAddress.city.toLowerCase().includes(searchTerm);
        
        return matchesStatus && matchesSearch;
      });
      
      displayOrders();
    }

    function displayOrders() {
      const container = document.getElementById('orders-container');
      
      if (filteredOrders.length === 0) {
        const searchValue = document.getElementById('search-input').value;
        let message = 'You haven\'t placed any orders yet. Start shopping to see your orders here!';
        
        if (searchValue) {
          message = `No orders found matching "${searchValue}"`;
        } else if (currentFilter !== 'all') {
          message = `No ${currentFilter} orders found`;
        }
          
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <h2 class="empty-title">No Orders Found</h2>
            <p class="empty-description">${message}</p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <button onclick="window.location.href='index.html'" class="action-btn action-btn-primary">
                Start Shopping
              </button>
              ${(currentFilter !== 'all' || searchValue) ? `
                <button onclick="resetFilters()" class="action-btn action-btn-secondary">
                  Clear Filters
                </button>
              ` : ''}
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredOrders.map(order => `
        <div class="order-card">
          <div class="order-card-header">
            <div>
              <h2 class="order-number">Order #${order.orderId}</h2>
              <div class="order-date-display">${formatDate(order.createdAt)}</div>
            </div>
            <div class="status-badge ${order.status}">
              <span>${getStatusIcon(order.status)}</span>
              <span>${order.status.toUpperCase()}</span>
            </div>
          </div>
          
          <div class="order-card-body">
            <div class="order-grid">
              <div class="items-section">
                <h3 class="section-title">Order Items</h3>
                ${order.items.map(item => `
                  <div class="item-row">
                    <div class="item-icon">üíä</div>
                    <div class="item-details">
                      <h4 class="item-name-display">${item.name}</h4>
                      <div class="item-meta">Qty: ${item.quantity} √ó ‚Çπ${item.price.toFixed(2)}</div>
                    </div>
                    <div class="item-price-display">‚Çπ${(item.price * item.quantity).toFixed(2)}</div>
                  </div>
                `).join('')}
              </div>
              
              <div class="sidebar-section">
                <div class="summary-box">
                  <h3 class="section-title">Order Summary</h3>
                  <div class="summary-row">
                    <span>Subtotal</span>
                    <span>‚Çπ${calculateSubtotal(order.items).toFixed(2)}</span>
                  </div>
                  <div class="summary-row">
                    <span>Delivery Fee</span>
                    <span>${order.total > 500 ? 'FREE' : '‚Çπ50.00'}</span>
                  </div>
                  <div class="summary-row total">
                    <span>Total</span>
                    <span>‚Çπ${order.total.toFixed(2)}</span>
                  </div>
                </div>
                
                <div class="address-box">
                  <h3 class="address-title">üìç Delivery Location</h3>
                  <div class="address-content">
                    <strong>${order.deliveryAddress.name}</strong>
                    ${order.deliveryAddress.address}<br>
                    ${order.deliveryAddress.city}, ${order.deliveryAddress.state}<br>
                    PIN: ${order.deliveryAddress.pincode}<br>
                    üìû ${order.deliveryAddress.phone}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="action-bar">
              <button class="action-btn action-btn-primary" onclick="downloadInvoice('${order.orderId}')">
                <span>üìÑ</span> Download Invoice
              </button>
              ${order.status === 'delivered' ? `
                <button class="action-btn action-btn-secondary" onclick="reorderItems('${order.orderId}')">
                  <span>üîÑ</span> Reorder
                </button>
              ` : ''}
              ${order.status === 'pending' || order.status === 'confirmed' ? `
                <button class="action-btn action-btn-secondary" onclick="cancelOrder('${order.orderId}')">
                  <span>‚úï</span> Cancel Order
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function getStatusIcon(status) {
      const icons = {
        'confirmed': '‚úì',
        'pending': '‚è≥',
        'delivered': '‚úì',
        'cancelled': '‚úó'
      };
      return icons[status] || '‚Ä¢';
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function calculateSubtotal(items) {
      return items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    }

    function resetFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('clear-search').style.display = 'none';
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.filter-btn[data-status="all"]').classList.add('active');
      currentFilter = 'all';
      applyFilters();
    }

    function downloadInvoice(orderId) {
      showToast(`Generating invoice for order ${orderId}...`, 'info');
    }

    function reorderItems(orderId) {
      showToast(`Adding items to cart...`, 'success');
    }

    async function cancelOrder(orderId) {
      console.log('Cancel order called for:', orderId);
      
      // Find the order to check its status
      const order = allOrders.find(o => o.orderId === orderId);
      
      if (!order) {
        console.error('Order not found:', orderId);
        showToast('Order not found', 'error');
        return;
      }

      console.log('Order found:', order);

      // Check if order can be cancelled
      if (order.status === 'delivered') {
        console.log('Cannot cancel - order is delivered');
        showToast('Cannot cancel delivered orders', 'error');
        return;
      }

      if (order.status === 'cancelled') {
        console.log('Cannot cancel - order is already cancelled');
        showToast('Order is already cancelled', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to cancel Order #${orderId}?\n\nThis action cannot be undone.`)) {
        console.log('User cancelled the confirmation dialog');
        return;
      }

      try {
        console.log('Starting cancel request...');
        showToast('Cancelling order...', 'warning');

        // Check if apiCall is available
        if (typeof window.apiCall !== 'function') {
          console.error('window.apiCall is not available');
          throw new Error('API connection not available. Please refresh the page.');
        }

        console.log('Calling API to cancel order:', orderId);
        const data = await window.apiCall(`/orders/${orderId}/cancel`, {
          method: 'PUT'
        });

        console.log('API Response:', data);

        if (data.success) {
          console.log('Order cancelled successfully');
          showToast('Order cancelled successfully!', 'success');
          
          // Update the order in the local array
          const orderIndex = allOrders.findIndex(o => o.orderId === orderId);
          if (orderIndex !== -1) {
            allOrders[orderIndex].status = 'cancelled';
            console.log('Updated allOrders array');
          }
          
          const filteredIndex = filteredOrders.findIndex(o => o.orderId === orderId);
          if (filteredIndex !== -1) {
            filteredOrders[filteredIndex].status = 'cancelled';
            console.log('Updated filteredOrders array');
          }

          // Refresh the display
          console.log('Refreshing display...');
          updateMetrics();
          displayOrders();
        } else {
          console.error('API returned success: false');
          showToast('Failed to cancel order', 'error');
        }
      } catch (error) {
        console.error('Cancel order error:', error);
        console.error('Error details:', error.message, error.stack);
        showToast(error.message || 'Failed to cancel order', 'error');
      }
    }

    window.loadOrders = loadOrders;
    window.resetFilters = resetFilters;
    window.downloadInvoice = downloadInvoice;
    window.reorderItems = reorderItems;
    window.cancelOrder = cancelOrder;
  </script>
</body>
</html>